


var data = [[6371000 + 154000, 0, -500, 10000]];
for (var i = 1; i < 20; i++){
    
    data[i] = RK45(data[i - 1][0], data[i - 1][1], data[i - 1][2], data[i - 1][3])
    console.log(data[i ][0], data[i][1], data[i][2], data[i][3]);
    
}



function RK45(r, t, vr, vt){
    
    var h = 10;
    for (var i = 0; i < 10; i++){

    var k1 =    a(
                    r,
                    vr, 
                    vt, 
                    h
                );
    var k2 =    a(
                    r  + 1 / 4 * k1[0],
                    vr + 1 / 4 * k1[2], 
                    vt + 1 / 4 * k1[3], 
                    h
                );
    var k3 =    a(
                    r  + 3 / 32 * k1[0] + 9 / 32 * k2[0],
                    vr + 3 / 32 * k1[2] + 9 / 32 * k2[2], 
                    vt + 3 / 32 * k1[3] + 9 / 32 * k2[3], 
                    h
                );
    var k4 =    a(
                    r  + 1932 / 2197 * k1[0] - 7200 / 2197 * k2[0] + 7296 / 2197 * k3[0],
                    vr + 1932 / 2197 * k1[2] - 7200 / 2197 * k2[2] + 7296 / 2197 * k3[2], 
                    vt + 1932 / 2197 * k1[3] - 7200 / 2197 * k2[3] + 7296 / 2197 * k3[3], 
                    h
                );
    var k5 =    a(
                    r  + 439 / 216 * k1[0] - 8 * k2[0] + 3680 / 513 * k3[0] - 845 / 4104 * k4[0],
                    vr + 439 / 216 * k1[2] - 8 * k2[2] + 3680 / 513 * k3[2] - 845 / 4104 * k4[2], 
                    vt + 439 / 216 * k1[3] - 8 * k2[3] + 3680 / 513 * k3[3] - 845 / 4104 * k4[3], 
                    h
                );
    var k6 =    a(
                    r  - 8 / 27 * k1[0] + 2 * k2[0] - 3544 / 2565 * k3[0] + 1859 / 4104 * k4[0] - 11 / 40 * k5[0],
                    vr - 8 / 27 * k1[2] + 2 * k2[2] - 3544 / 2565 * k3[2] + 1859 / 4104 * k4[2] - 11 / 40 * k5[2], 
                    vt - 8 / 27 * k1[3] + 2 * k2[3] - 3544 / 2565 * k3[3] + 1859 / 4104 * k4[3] - 11 / 40 * k5[3], 
                    h
                );
                
    
    var r1 = r + 25 / 216 * k1[0] + 1408 / 2565 * k3[0] + 2197 / 4104 * k4[0] - 1 / 5 * k5[0];
    var r2 = r + 16 / 135 * k1[0] + 6656 / 12825 * k3[0] + 28561 / 56430 * k4[0] - 9 / 50 * k5[0] + 2 / 55 * k6[0];
    
    var t1 = t + 25 / 216 * k1[1] + 1408 / 2565 * k3[1] + 2197 / 4104 * k4[1] - 1 / 5 * k5[1];
    var t2 = t + 16 / 135 * k1[1] + 6656 / 12825 * k3[1] + 28561 / 56430 * k4[1] - 9 / 50 * k5[1] + 2 / 55 * k6[1];
    
    var vr1 = vr + 25 / 216 * k1[2] + 1408 / 2565 * k3[2] + 2197 / 4104 * k4[2] - 1 / 5 * k5[2];
    var vr2 = vr + 16 / 135 * k1[2] + 6656 / 12825 * k3[2] + 28561 / 56430 * k4[2] - 9 / 50 * k5[2] + 2 / 55 * k6[2];
    
    var vt1 = vt + 25 / 216 * k1[3] + 1408 / 2565 * k3[3] + 2197 / 4104 * k4[3] - 1 / 5 * k5[3];
    var vt2 = vt + 16 / 135 * k1[3] + 6656 / 12825 * k3[3] + 28561 / 56430 * k4[3] - 9 / 50 * k5[3] + 2 / 55 * k6[3];  
    
    var rError = 0.1 * h / Math.abs(r1 - r2);
    var tError = 1e-7 * h / Math.abs(t1 - t2);
    var vrError = 1e-8 * h / Math.abs(vr1 - vr2);
    var vtError = 1e-8 * h / Math.abs(vt1 - vt2);
    
    var maxError = Math.min(rError, tError, vrError, vtError);
    
    var sh = 0.84 * Math.pow(maxError, 1 / 4) * h;
    
    if (Math.abs(h - sh) / sh < 1e-1){
        console.log(h);
        break;
    }

    h = sh;
    
    }
    
    return [r2, t2, vr2, vt2];

}

function a(r, vr, vt, h){

    var ar = vt * vt / r - 3.986e14 / r / r;
    var at = vt * (r / (r + vr) - 1);
    
    return [h * vr, h * vt / r, h * ar, h * at];
}